<!-- templates/suivi_conducteurs/create_evaluation.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Créer une évaluation - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- <link href="{% static 'css/evaluation.css' %}" rel="stylesheet"> -->
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script src="{% static 'js/validation.js' %}"></script>
{% endblock %}

{% block main_class %}container mt-4{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-12">
		<h1 class="mb-4 text-primary">
			<i class="fas fa-clipboard-check text-primary"></i>
			Créer une évaluation
		</h1>

		<div class="card">
			<div class="card-header">
				<h5 class="card-title mb-0 text-primary">Informations de l'évaluation</h5>
			</div>
			<div class="card-body">
				<form id="evaluation-form" method="post" action="{% url 'suivi_conducteurs:submit_evaluation' %}">
					{% csrf_token %}

					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="conducteur" class="form-label text-primary">Conducteur à évaluer</label>
								<select name="conducteur" id="conducteur" class="form-select" required>
									<option value="">Sélectionner un conducteur</option>
									{% for conducteur in conducteurs %}
									<option value="{{ conducteur.id }}">
										{{ conducteur.nom_complet }} - {{ conducteur.salsocid.socnom }}
									</option>
									{% endfor %}
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="mb-3">
								<label for="evaluateur" class="form-label text-primary">
									Évaluateur
									<small class="text-primary">(RH ou Exploitation uniquement)</small>
								</label>
								<select name="evaluateur" id="evaluateur" class="form-select" required>
									{% if not evaluateurs %}
										<option value="">Aucun évaluateur disponible</option>
									{% else %}
										{% for evaluateur in evaluateurs %}
		<option value="{{ evaluateur.id }}" selected
			data-groups="{% if evaluateur.user %}{% for group in evaluateur.user.groups.all %}{{ group.name }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}">
			{{ evaluateur.nom_complet }} - {{ evaluateur.service.nom }}
			{% if evaluateur.service.abreviation %}({{ evaluateur.service.abreviation }}){% endif %}
		</option>
										{% endfor %}
									{% endif %}
								</select>
								<div class="form-text">
									{% if evaluateurs %}
										<i class="fas fa-info-circle text-info me-1"></i>
										Vous êtes pré-sélectionné comme évaluateur pour cette évaluation.
									{% else %}
										<i class="fas fa-exclamation-triangle text-warning me-1"></i>
										Vous n'avez pas les permissions nécessaires pour effectuer une évaluation.
										<br><small>Seuls les utilisateurs des groupes RH et Exploitation peuvent évaluer.</small>
									{% endif %}
								</div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="type_evaluation" class="form-label text-primary">Type d'évaluation</label>
								<select name="type_evaluation" id="type_evaluation" class="form-select" required
									hx-get="{% url 'suivi_conducteurs:load_criteres_htmx' %}"
									hx-target="#criteres-container" hx-trigger="change" hx-include="this">
									<option value="">Sélectionner un type</option>
									{% for type_eval in types_evaluation %}
									<option value="{{ type_eval.id }}">{{ type_eval.nom }}</option>
									{% endfor %}
								</select>
							</div>
						</div>

						<div class="col-md-6">
							<div class="mb-3">
								<label for="date_evaluation" class="form-label text-primary">Date d'évaluation</label>
										<input type="hidden" name="date_evaluation" id="date_evaluation" value="{{ date_du_jour|date:'Y-m-d' }}">
										<div class="form-control-plaintext bg-light border rounded px-3 py-2">
											{{ date_du_jour|date:"d/m/Y" }}
										</div>
										</div>
						</div>
					</div>

					<!-- Avertissement si pas d'évaluateur disponible -->
					{% if not evaluateurs %}
					<div class="alert alert-warning">
						<h5><i class="fas fa-exclamation-triangle me-2"></i>Aucun évaluateur disponible</h5>
						<p class="mb-2">
							Aucun évaluateur des groupes RH ou Exploitation n'a été trouvé.
							Pour pouvoir créer une évaluation, il faut :
						</p>
						<ul class="mb-3">
							<li>Que des utilisateurs soient assignés aux groupes "RH" ou "Exploitation"</li>
							<li>Que ces utilisateurs aient un profil évaluateur créé</li>
						</ul>
						<div class="d-flex gap-2">
							{% if user.is_staff %}
							<a href="{% url 'admin:auth_group_changelist' %}" class="btn btn-outline-primary btn-sm">
								<i class="fas fa-users me-1"></i>Gérer les groupes
							</a>
							<a href="{% url 'admin:suivi_conducteurs_evaluateur_changelist' %}"
								class="btn btn-outline-info btn-sm">
								<i class="fas fa-user-tie me-1"></i>Gérer les évaluateurs
							</a>
							{% endif %}
							<a href="{% url 'suivi_conducteurs:evaluation_list' %}"
								class="btn btn-outline-secondary btn-sm">
								<i class="fas fa-list me-1"></i>Retour à la liste
							</a>
						</div>
					</div>
					{% endif %}

					<!-- Container pour les critères (chargé via HTMX) -->
					<div id="criteres-container">
						<!-- Les critères seront chargés ici via HTMX -->
					</div>

					<div class="d-flex justify-content-between mt-4">
						<a href="{% url 'suivi_conducteurs:evaluation_list' %}" class="btn btn-secondary">
							<i class="fas fa-arrow-left"></i> Retour à la liste
						</a>
						<button type="button" id="submit-btn" class="btn btn-success" {% if not evaluateurs %} style="display: none;" {% endif %}>
							<i class="fas fa-save"></i> Créer l'évaluation
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Informations sur les évaluateurs -->
		{% if evaluateurs %}
		<div class="card mt-4">
			<div class="card-header bg-info text-white">
				<h6 class="card-title mb-0">
					<i class="fas fa-info-circle me-2"></i>
					Évaluateurs disponibles ({{ evaluateurs.count }})
				</h6>
			</div>
			<div class="card-body">
				<div class="row">
					{% for evaluateur in evaluateurs %}
					<div class="col-md-4 mb-3">
						<div class="card border-0 bg-light h-100">
							<div class="card-body p-3">
								<div class="d-flex align-items-center">
									<i class="fas fa-user-tie fa-2x text-primary me-3"></i>
									<div>
										<h6 class="mb-1">{{ evaluateur.nom_complet }}</h6>
										<small class="text-muted">{{ evaluateur.service.nom }}</small>
										<div class="mt-1">
											{% for group in evaluateur.user.groups.all %}
											<span class="badge me-1"
												style="background-color: {% if group.groupe_etendu %}{{ group.groupe_etendu.couleur }}{% else %}var(--bs-secondary){% endif %}; font-size: 0.7rem;">
												{{ group.name }}
											</span>
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
		{% endif %}
	</div>
</div>
{% endblock %}

{% block init_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
	const submitBtn = document.getElementById('submit-btn');
	const form = document.getElementById('evaluation-form');
	
	function checkForm() {
		const conducteur = document.getElementById('conducteur').value;
		const evaluateur = document.getElementById('evaluateur').value;
		const typeEval = document.getElementById('type_evaluation').value;
		
		// Activer/désactiver le bouton selon la validité du formulaire
		if (conducteur && evaluateur && typeEval) {
			submitBtn.disabled = false;
			submitBtn.classList.remove('disabled');
			submitBtn.classList.add('btn-success');
			submitBtn.classList.remove('btn-secondary');
		} else {
			submitBtn.disabled = true;
			submitBtn.classList.add('disabled');
			submitBtn.classList.add('btn-secondary');
			submitBtn.classList.remove('btn-success');
		}
	}
	
	// Écouter les changements sur les champs principaux
	document.getElementById('conducteur').addEventListener('change', checkForm);
	document.getElementById('evaluateur').addEventListener('change', checkForm);
	document.getElementById('type_evaluation').addEventListener('change', checkForm);
	
	// Gérer HTMX pour les critères
	document.body.addEventListener('htmx:afterRequest', function (evt) {
		if (evt.detail.target.id === 'criteres-container') {
			setTimeout(checkForm, 100);
		}
	});
	
	// Gestionnaire de clic pour soumission
	submitBtn.addEventListener('click', function(e) {
		if (submitBtn.disabled) {
			return false;
		}
		
		// Vérifier les champs requis
		const conducteur = document.getElementById('conducteur').value;
		const evaluateur = document.getElementById('evaluateur').value;
		const typeEval = document.getElementById('type_evaluation').value;
		
		if (!conducteur || !evaluateur || !typeEval) {
			alert('Veuillez remplir tous les champs requis');
			return false;
		}
		
		// Soumettre le formulaire
		form.submit();
	});
	
	// Masquer le bouton s'il n'y a pas d'évaluateurs
	const evaluateurSelect = document.getElementById('evaluateur');
	if (!evaluateurSelect.options.length || !evaluateurSelect.options[0].value) {
		submitBtn.style.display = 'none';
	}
	
	// Vérification initiale
	checkForm();
});
</script>
{% endblock %}
