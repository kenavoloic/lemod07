<!-- templates/registration/login.html - Version avec toggle password fonctionnel -->
{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Connexion - Suivi des Conducteurs{% endblock %}

{% block body_class %}login-page{% endblock %}

{% block extra_css %}
<style>
	/* Style spécifique pour le toggle password */
	.password-toggle {
		position: absolute;
		right: 10px;
		top: 50%;
		transform: translateY(-50%);
		background: none;
		border: none;
		padding: 0;
		color: #6c757d;
		cursor: pointer;
		z-index: 10;
	}

	.password-toggle:hover {
		color: #495057;
	}

	.password-toggle:focus {
		outline: none;
		box-shadow: none;
	}

	.password-input-group {
		position: relative;
	}

	.password-input-group .form-control {
		padding-right: 40px;
	}
</style>
{% endblock %}

{% block content %}
<div class="login-body">
	<div class="container">
		<div class="row justify-content-center">
			<div class="col-md-6 col-lg-5">
				<div class="card login-card animate-bounce-in">
					<div class="login-header text-center">
						<h2 class="mb-2">Suivi des Conducteurs</h2>
						<p class="mb-0 opacity-75">Connectez-vous</p>
					</div>

					<div class="login-form-body">
						<form id="login-form" method="post" data-validate="true">
							{% csrf_token %}

							<!-- Champ nom d'utilisateur -->
							<div class="mb-4">
								<label for="{{ form.username.id_for_label }}" class="form-label">
									<i class="fas fa-user me-2"></i>Nom d'utilisateur
								</label>
								<div class="input-group">
									<span class="input-group-text">
										<i class="fas fa-user"></i>
									</span>
									<input type="text" class="form-control" name="{{ form.username.name }}"
										id="{{ form.username.id_for_label }}" placeholder="Votre nom d'utilisateur"
										value="{{ form.username.value|default:'' }}" required autocomplete="username">
								</div>
								{% if form.username.errors %}
								<div class="invalid-feedback d-block">
									{% for error in form.username.errors %}{{ error }}{% endfor %}
								</div>
								{% endif %}
							</div>

							<!-- Champ mot de passe avec toggle -->
							<div class="mb-4">
								<label for="{{ form.password.id_for_label }}" class="form-label">
									<i class="fas fa-lock me-2"></i>Mot de passe
								</label>
								<div class="input-group">
									<span class="input-group-text">
										<i class="fas fa-lock"></i>
									</span>
									<div class="password-input-group flex-grow-1">
										<input type="password" class="form-control" name="{{ form.password.name }}"
											id="{{ form.password.id_for_label }}" placeholder="Votre mot de passe"
											required autocomplete="current-password">
										<button type="button" class="password-toggle" id="togglePassword"
											title="Afficher/masquer le mot de passe"
											aria-label="Afficher/masquer le mot de passe"
											data-handled="true">
											<i class="fas fa-eye" id="toggleIcon"></i>
										</button>
									</div>
								</div>
								{% if form.password.errors %}
								<div class="invalid-feedback d-block">
									{% for error in form.password.errors %}{{ error }}{% endfor %}
								</div>
								{% endif %}
							</div>

							<!-- Bouton de connexion -->
							<div class="d-grid">
								<button type="submit" class="btn btn-login" id="loginButton">
									<i class="fas fa-sign-in-alt me-2"></i>
									Se connecter
								</button>
							</div>
						</form>

						<hr class="my-4">

						<div class="text-center">
							<div class="row">
								<div class="col-12 mb-2">
									<small class="text-muted">
										<i class="fas fa-shield-alt me-1"></i>
										Connexion sécurisée
									</small>
								</div>
								<div class="col-12">
									<a href="/admin/" class="btn btn-outline-secondary btn-sm">
										<i class="fas fa-cog me-1"></i>
										Administration
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="text-center mt-3 mx-auto">
					<p class="text-white">
					  {% now "l j F Y" as date_du_jour %}
					  {{ date_du_jour|capfirst }}
					</p>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>

<script>
	// Script spécifique pour le toggle password
	document.addEventListener('DOMContentLoaded', function () {
		const passwordField = document.getElementById('{{ form.password.id_for_label }}');
		const toggleButton = document.getElementById('togglePassword');
		const toggleIcon = document.getElementById('toggleIcon');

		if (toggleButton && passwordField && toggleIcon) {
			// Supprimer tout event listener existant pour éviter les conflits
			const newToggleButton = toggleButton.cloneNode(true);
			toggleButton.parentNode.replaceChild(newToggleButton, toggleButton);
			
			// Récupérer les nouvelles références après le clonage
			const finalToggleButton = document.getElementById('togglePassword');
			const finalToggleIcon = document.getElementById('toggleIcon');
			
			finalToggleButton.addEventListener('click', function (e) {
				e.preventDefault();
				e.stopPropagation();

				// Basculer le type de champ
				const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
				passwordField.setAttribute('type', type);

				// Basculer l'icône
				if (type === 'password') {
					finalToggleIcon.className = 'fas fa-eye';
					finalToggleButton.title = 'Afficher le mot de passe';
				} else {
					finalToggleIcon.className = 'fas fa-eye-slash';
					finalToggleButton.title = 'Masquer le mot de passe';
				}

				// Focus sur le champ après le basculement
				passwordField.focus();
			});

			// Gestion du clavier (Entrée sur le bouton)
			finalToggleButton.addEventListener('keydown', function (e) {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					finalToggleButton.click();
				}
			});
		}

		// Gestion du formulaire de connexion
		const loginForm = document.getElementById('login-form');
		const loginButton = document.getElementById('loginButton');

		if (loginForm && loginButton) {
			loginForm.addEventListener('submit', function (e) {
				// Afficher l'état de chargement
				const originalText = loginButton.innerHTML;
				loginButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connexion en cours...';
				loginButton.disabled = true;

				// En cas d'erreur (si le formulaire ne se soumet pas), restaurer le bouton
				setTimeout(() => {
					if (loginButton.disabled) {
						loginButton.innerHTML = originalText;
						loginButton.disabled = false;
					}
				}, 5000);
			});
		}

		// Auto-focus sur le champ nom d'utilisateur
		const usernameField = document.getElementById('{{ form.username.id_for_label }}');
		if (usernameField && !usernameField.value) {
			usernameField.focus();
		}
	});

	// Gestion des messages d'erreur
	{% if form.non_field_errors or form.username.errors or form.password.errors %}
	document.addEventListener('DOMContentLoaded', function () {
		// Animation shake pour les champs en erreur
		const errorFields = document.querySelectorAll('.is-invalid, .has-error');
		errorFields.forEach(field => {
			field.style.animation = 'shake 0.5s ease-in-out';
		});
	});

	// Animation shake CSS
	const shakeStyle = document.createElement('style');
	shakeStyle.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
`;
	document.head.appendChild(shakeStyle);
	{% endif %}
</script>
{% endblock %}
